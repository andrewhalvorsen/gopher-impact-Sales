<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smokin’ Burrow – Rodent Impact (1-Year, Natural Only)</title>
<style>
  :root{ --yellow:#f4cf2f; --ink:#0f172a; --border:#e5e7eb; --bg:#f8fafc; --card:#ffffff; --radius:20px; --shadow:0 18px 40px rgba(0,0,0,.08); }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }
  .wrap{ max-width:1100px; margin:48px auto; padding:0 20px; display:grid; grid-template-columns:420px 1fr; gap:28px; }
  .panel{ border-radius:var(--radius); box-shadow:var(--shadow); }
  .left{ background:var(--yellow); padding:32px 26px; display:flex; flex-direction:column; gap:26px; }
  .right{ background:var(--card); padding:28px 26px; }

  .lead h1{ margin:0; font-size:26px; line-height:1.15; letter-spacing:-0.01em; }
  .group{ display:flex; flex-direction:column; gap:12px; }
  .label{ font-weight:800; font-size:13px; letter-spacing:.04em; text-transform:uppercase; }

  .segmented{ display:grid; grid-template-columns: repeat(3, 1fr); width:100%; padding:6px; gap:0; border-radius:14px; background:rgba(255,255,255,.50); border:2px solid rgba(0,0,0,.06); }
  .segmented button{ appearance:none; border:0; cursor:pointer; width:100%; padding:14px 0; font-weight:800; font-size:15px; color:#0f172a; background:transparent; border-radius:10px; border:2px solid transparent; transition:background .12s, transform .06s, box-shadow .12s, opacity .12s; }
  .segmented button:hover{ background:rgba(255,255,255,.35); }
  .segmented button:active{ transform:translateY(1px); }
  .segmented button.active{ background:#fff; border-color:rgba(0,0,0,.06); box-shadow:0 8px 20px rgba(0,0,0,.10); }
  .segmented button.inactive{ opacity:.55; }

  /* Acres input */
  .inputline{ display:flex; align-items:center; gap:10px; }
  .inputline input{ width:140px; padding:10px 12px; border-radius:10px; border:2px solid rgba(0,0,0,.10); font-size:16px; font-weight:700; background:#fff; }
  .inputline .unit{ font-weight:800; font-size:14px; letter-spacing:.02em; }

  .switch{ display:flex; align-items:center; gap:12px; font-weight:700; }
  .switch input{ display:none; }
  .toggle{ width:54px; height:30px; border-radius:999px; background:rgba(0,0,0,.25); position:relative; cursor:pointer; }
  .toggle:after{ content:""; position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18); transition:transform .18s ease; }
  .switch input:checked + .toggle{ background:#16a34a; }
  .switch input:checked + .toggle:after{ transform:translateX(24px); }

  .disclaimer{ margin-top:8px; font-size:12px; line-height:1.4; color:#111827; opacity:.9; }

  .headerline{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px; }
  .title{ font-size:16px; font-weight:800; letter-spacing:.06em; text-transform:uppercase; color:#374151; display:flex; align-items:center; gap:8px; }
  .pricepill{ padding:2px 10px; border-radius:999px; background:#eef2ff; color:#1f2937; font-size:12px; font-weight:800; cursor:text; }
  #priceEdit:focus{ outline:none; }

  .grid{ display:grid; grid-template-columns:1fr; gap:18px; }
  .card{ border:1px solid var(--border); border-radius:16px; padding:16px; background:#fff; }
  .card h3{ margin:0 0 8px; font-size:13px; letter-spacing:.06em; color:#6b7280; text-transform:uppercase; }
  .metric{ display:flex; align-items:baseline; gap:10px; margin:10px 0 6px; }
  .num{ font-size:34px; font-weight:900; letter-spacing:-0.02em; }
  .badge{ padding:4px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; font-weight:800; color:#374151; }

  .tbl{ width:100%; border-collapse:collapse; font-size:14px; }
  .tbl td{ padding:8px 0; border-bottom:1px dashed var(--border); }
  .tbl td:last-child{ text-align:right; font-variant-numeric:tabular-nums; }
  .tbl tr:last-child td{ border-bottom:none; font-weight:800; }

  /* Pins/acre key styling */
  .key{ margin-top:4px; padding:10px 12px; border-radius:12px; background:rgba(255,255,255,.45); border:1px solid rgba(0,0,0,.06); font-size:12px; line-height:1.35; color:#111827; }

  @media (max-width:1024px){ .wrap{ grid-template-columns:1fr; } }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT / CONTROLS -->
    <section class="panel left" aria-label="Controls">
      <div class="lead"><h1>See how much rodents cost you</h1></div>

      <!-- Infestation -->
      <div class="group">
        <div class="label">Infestation Level</div>
        <div class="segmented" role="tablist" aria-label="Infestation Level">
          <button type="button" class="infbtn" data-level="1" role="tab" aria-selected="false">Low</button>
          <button type="button" class="infbtn active" data-level="2" role="tab" aria-selected="true">Medium</button>
          <button type="button" class="infbtn" data-level="3" role="tab" aria-selected="false">High</button>
        </div>
      </div>

      <!-- Rodents (multi-select) -->
      <div class="group">
        <div class="label">Rodents</div>
        <div class="segmented" role="group" aria-label="Rodent species">
          <button type="button" class="rodentbtn active" data-kind="gopher">Gophers</button>
          <button type="button" class="rodentbtn" data-kind="squirrel">Squirrels</button>
          <button type="button" class="rodentbtn" data-kind="rat">Rats</button>
        </div>
      </div>

      <!-- Acres (typeable) -->
      <div class="group">
        <div class="label">Acres</div>
        <div class="inputline">
          <input id="acres" type="number" inputmode="numeric" min="1" step="1" value="40" aria-label="Acres" />
          <span class="unit">acres</span>
        </div>
      </div>

      <!-- Owl Boxes -->
      <div class="group">
        <label class="switch">
          <input id="owls" type="checkbox" aria-label="Owl Boxes" />
          <span class="toggle" aria-hidden="true"></span>
          <span>Owl Boxes</span>
        </label>
        <p class="disclaimer">
          *Disclaimer: Estimates are based on research and field data. Results may vary and are not guaranteed.
        </p>
      </div>

      <!-- Pins/acre key -->
      <div class="group">
        <div class="key" aria-label="Pins per acre guide">
          <div>Low: 1–2 pins/acre</div>
          <div>Medium: 3–4 pins/acre</div>
          <div>High: 5+ pins/acre</div>
        </div>
      </div>
    </section>

    <!-- RIGHT / RESULTS -->
    <section class="panel right" aria-live="polite" aria-atomic="true">
      <div class="headerline">
        <div class="title">
          1-Year Impact (Almonds)
          <span id="almondPrice" class="pricepill"></span>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Natural</h3>
          <div class="metric"><div class="num" id="nat_total">$—</div><span class="badge">Total Damage</span></div>
          <table class="tbl"><tbody id="nat_break"></tbody></table>
        </div>
      </div>
    </section>
  </div>

<script>
/* ------------------------------ Helpers ------------------------------ */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));
function money(n){ return "$"+Math.round(n).toLocaleString("en-US"); }

/* ------------------------------ Model (1-Year, deterministic) ------------------------------ */
/* Shared life-history */
const litterMean = 6.0;
const birthFracFemale = 0.70;
const breederFrac = 0.80;
const fertSlope = 3.5;
const survJ = 0.45, survS = 0.65, survA = 0.82;
const agingA = 0.08;

/* Owls (population-linked damage reduction) */
const OWLS_PER_100_ACRES = 1.9;
const PREDATION_PER_OWL_PER_WEEK = 4.0;
const BETA_YIELD = 0.55;
const BETA_NON   = 1.00;
const OWL_MIN_FACTOR = 0.60;

/* Economics (price is editable via pill) */
let pricePerLb = 2.50;
const yieldLbPerAcre = 2500.0;
const lossMild = 0.02, lossMedium = 0.04, lossSevere = 0.06;

/* Rebalanced per-acre baselines (before severity & species multipliers) */
const dripPerAcre_base = 80.0;
const cropDmgPerAcre_base = 60.0;
const miscPerAcre_base   = 30.0;

const sevMultMild = 0.8, sevMultMed = 1.0, sevMultSev = 1.2;

/* Species parameters */
const speciesParams = {
  gopher:   {
    K_per_acre: 80,
    basePer10: {1:20, 2:40, 3:70},
    mult: { yield: 1.00, drip: 1.30, crop: 1.10, misc: 1.00 }
  },
  squirrel: {
    K_per_acre: 60,
    basePer10: {1:12, 2:24, 3:40},
    mult: { yield: 1.10, drip: 0.70, crop: 1.20, misc: 1.00 }
  },
  rat:      {
    K_per_acre: 70,
    basePer10: {1:15, 2:30, 3:50},
    mult: { yield: 0.80, drip: 0.90, crop: 0.90, misc: 1.30 }
  }
};

/* Linear drop-off config (1st, 2nd, 3rd species weights) */
const DROP_STEP = 0.5;   // linear decrement per additional species
const MIN_WEIGHT = 0.3;  // floor so the 3rd species still contributes meaningfully

/* One-species annual step (for owl population effect only) */
function stepSpeciesOnce(P, acres, owlsOn, K_per_acre){
  let [Jf,Jm,Sf,Sm,Af,Am] = [P[0][0],P[0][1],P[1][0],P[1][1],P[2][0],P[2][1]];
  const K_total = K_per_acre * acres;
  const total   = Jf+Jm+Sf+Sm+Af+Am;
  const density = K_total>0 ? total / K_total : 0.0;

  const fertMult = 1.0 / (1.0 + Math.exp(fertSlope * (density - 1.0)));
  const breeders = Af * breederFrac;
  const births   = breeders * litterMean * fertMult;
  const pupsF    = births * birthFracFemale;
  const pupsM    = births * (1.0 - birthFracFemale);

  let nextJf = pupsF;
  let nextJm = pupsM;
  let nextSf = Jf * survJ;
  let nextSm = Jm * survJ;
  let nextAf = Sf * survS + Af * survA;
  let nextAm = Sm * survS + Am * survA;

  nextAf = Math.max(0, nextAf - Af * agingA);
  nextAm = Math.max(0, nextAm - Am * agingA);

  if (owlsOn){
    const owlsEff = OWLS_PER_100_ACRES * (acres/100.0);
    const afterTot = nextJf + nextJm + nextSf + nextSm + nextAf + nextAm;
    const densityAfter = K_total>0 ? Math.min(1.0, afterTot / K_total) : 0.0;
    const owlRemoval = owlsEff * PREDATION_PER_OWL_PER_WEEK * 52.0 * Math.max(0, Math.min(1, densityAfter));
    if(afterTot > 0 && owlRemoval > 0){
      const frac = Math.min(1, owlRemoval / afterTot);
      const k = 1 - frac;
      nextJf*=k; nextJm*=k; nextSf*=k; nextSm*=k; nextAf*=k; nextAm*=k;
    }
  }

  return [[nextJf,nextJm],[nextSf,nextSm],[nextAf,nextAm]];
}

const sumAll=P=>P[0][0]+P[0][1]+P[1][0]+P[1][1]+P[2][0]+P[2][1];

/* Population after one year (for owl discount rN) */
function combinedPopAfterOneYear(acres, level, active, owlsOn){
  let total = 0;
  for (const key of active){
    const sp = speciesParams[key];
    const totalInit = sp.basePer10[level] * (acres/10);
    const Af0 = totalInit * birthFracFemale, Am0 = totalInit * (1 - birthFracFemale);
    const P0 = [[0,0],[0,0],[Af0,Am0]];
    const P1 = stepSpeciesOnce(P0, acres, owlsOn, sp.K_per_acre);
    total += sumAll(P1);
  }
  return total;
}

/* Standalone damage for a single species (no owls) */
function speciesStandaloneDamage(acres, level, key){
  const sevMult = (level===1?sevMultMild:(level===2?sevMultMed:sevMultSev));
  const baseRevenue = acres * yieldLbPerAcre * pricePerLb;
  const lossRate = (level===1?lossMild:(level===2?lossMedium:lossSevere));
  const m = speciesParams[key].mult;

  const lossOfCrop = baseRevenue * lossRate * m.yield;
  const drip  = dripPerAcre_base    * sevMult * acres * m.drip;
  const cropD = cropDmgPerAcre_base * sevMult * acres * m.crop;
  const misc  = miscPerAcre_base    * sevMult * acres * m.misc;
  const total = lossOfCrop + drip + cropD + misc;
  return {lossOfCrop, drip, cropD, misc, total};
}

/* Linear drop-off weighted sum across species */
function weightedSumDamages(acres, level, activeSet){
  const list = Array.from(activeSet).map(k => ({ key:k, dmg: speciesStandaloneDamage(acres, level, k) }));
  if (list.length === 0) return {lossOfCrop:0, drip:0, cropD:0, misc:0, total:0};

  // Sort by standalone total descending so biggest driver gets weight 1.0
  list.sort((a,b)=> b.dmg.total - a.dmg.total);

  // Build weights linearly: 1.0, 1.0-DROP_STEP, 1.0-2*DROP_STEP, ... with a floor
  const weights = list.map((_,i)=> Math.max(MIN_WEIGHT, 1 - i*DROP_STEP));

  // Weighted sum
  let lossOfCrop=0, drip=0, cropD=0, misc=0;
  list.forEach((item,i)=>{
    const w = weights[i], d = item.dmg;
    lossOfCrop += w * d.lossOfCrop;
    drip       += w * d.drip;
    cropD      += w * d.cropD;
    misc       += w * d.misc;
  });
  const total = lossOfCrop + drip + cropD + misc;
  return {lossOfCrop, drip, cropD, misc, total};
}

/* Final 1-year damages (with owl discounts applied to the weighted sum) */
function computeOneYear(acres, level, owlsOn, activeSet){
  if (activeSet.size === 0){
    return { lossOfCrop:0, drip:0, cropD:0, misc:0, total:0 };
  }

  // Base weighted damages with linear drop-off
  let D = weightedSumDamages(acres, level, activeSet);

  // Owl discounts
  if (owlsOn){
    const eps=1e-9;
    const totOff = combinedPopAfterOneYear(acres, level, Array.from(activeSet), false);
    const totOn  = combinedPopAfterOneYear(acres, level, Array.from(activeSet), true);
    const rN = Math.max(0, (totOff - totOn) / Math.max(eps, totOff));

    const fY = clamp(1 - BETA_YIELD * rN, OWL_MIN_FACTOR, 1.0);
    const fN = clamp(1 - BETA_NON  * rN, OWL_MIN_FACTOR, 1.0);

    D.lossOfCrop *= fY;
    D.drip *= fN; D.cropD *= fN; D.misc *= fN;
    D.total = D.lossOfCrop + D.drip + D.cropD + D.misc;
  }

  // Clamp non-negatives
  D.lossOfCrop=Math.max(0,D.lossOfCrop);
  D.drip=Math.max(0,D.drip); D.cropD=Math.max(0,D.cropD); D.misc=Math.max(0,D.misc);
  D.total = D.lossOfCrop + D.drip + D.cropD + D.misc;
  return D;
}

/* ------------------------------ Render & inputs ------------------------------ */
let lastValidAcres = 40;
const activeRodents = new Set(["gopher"]); // default ON

function activeLevel(){
  const btn=$$(".infbtn").find(b=>b.classList.contains("active"));
  return parseInt(btn.dataset.level,10);
}

/* Acres input handling (lax while typing, strict on blur) */
function readAcresLax(){
  const input = $("#acres");
  const v = parseInt(input.value, 10);
  if (!Number.isFinite(v) || v < 1) return null;
  lastValidAcres = v; return v;
}
function readAcresStrict(){
  const input = $("#acres");
  let v = parseInt(input.value, 10);
  if (!Number.isFinite(v) || v < 1) v = lastValidAcres || 1;
  input.value = v; lastValidAcres = v; return v;
}

/* Price pill editor */
function installPriceEditor(){
  const pill = $("#almondPrice");
  pill.innerHTML = `$<span id="priceEdit" contenteditable="true" spellcheck="false" aria-label="Almond price per pound">${pricePerLb.toFixed(2)}</span>/lb`;
  const ed = $("#priceEdit");

  ed.addEventListener("focus", ()=>{
    const range = document.createRange(); range.selectNodeContents(ed);
    const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
  });
  ed.addEventListener("keydown", (e)=>{ if (e.key === "Enter"){ e.preventDefault(); ed.blur(); }});
  ed.addEventListener("blur", ()=>{
    const raw = ed.textContent || "";
    const num = parseFloat(raw.replace(/[^0-9.]/g,""));
    if (Number.isFinite(num) && num > 0){ pricePerLb = num; }
    ed.textContent = pricePerLb.toFixed(2);
    render(lastValidAcres);
  });
}

/* Rodent toggle handling (multi-select pills) */
function installRodentToggles(){
  $$(".rodentbtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const k = btn.dataset.kind;
      const isActive = btn.classList.toggle("active");
      if (isActive) activeRodents.add(k); else activeRodents.delete(k);
      render(lastValidAcres);
    });
  });
}

/* Render */
function render(acres){
  const level = activeLevel();
  const owlsOn = $("#owls").checked;
  const d = computeOneYear(acres, level, owlsOn, activeRodents);

  $("#nat_total").textContent = money(d.total);
  $("#nat_break").innerHTML = `
    <tr><td>Loss of crop</td><td>${money(d.lossOfCrop)}</td></tr>
    <tr><td>Drip/irrigation</td><td>${money(d.drip)}</td></tr>
    <tr><td>Crop damage</td><td>${money(d.cropD)}</td></tr>
    <tr><td>Misc</td><td>${money(d.misc)}</td></tr>
    <tr><td>Total</td><td>${money(d.total)}</td></tr>
  `;
}

/* Events */
$$(".infbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $$(".infbtn").forEach(b=>{ const on=(b===btn); b.classList.toggle("active",on); b.setAttribute("aria-selected", on?"true":"false"); });
    render(lastValidAcres);
  });
});

$("#acres").addEventListener("input", ()=>{
  const v = readAcresLax();
  if (v !== null) render(v);
});
$("#acres").addEventListener("blur", ()=>{
  const v = readAcresStrict();
  render(v);
});

$("#owls").addEventListener("change", ()=>render(lastValidAcres));

window.addEventListener("load", ()=>{
  lastValidAcres = parseInt($("#acres").value,10) || 40;
  installPriceEditor();
  installRodentToggles();
  render(lastValidAcres);
});
</script>
</body>
</html>
